<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Members Â· Lucky Friday</title>
    <link rel="stylesheet" href="/css/dashboard.css" />
    <style>
        /* Members-specific styles only */
        .members-count {
            font-size: 14px;
            color: var(--text-muted);
            margin: 0;
        }

        .members-table {
            table-layout: fixed;
        }

        .members-table th:first-child {
            width: 80px;
        }

        .members-table th:last-child {
            width: 180px;
            text-align: right;
        }

        .members-table td:last-child {
            text-align: right;
        }
    </style>
</head>

<body>
    <header>
        <div class="header-title">Ditmemay1xbet</div>
        <div class="header-center">
            <div class="role-toggle" role="group" aria-label="Role selector">
                <button id="role-accountant" type="button" class="active" data-role="accountant">Accountant</button>
                <button id="role-bet" type="button" data-role="bet">Bet Master</button>
            </div>
        </div>
        <div class="header-right">
            <div class="theme-toggle" role="group" aria-label="Theme selector">
                <button id="theme-light" type="button" class="active">
                    <img src="/imgs/icons/ic_sun.png" alt="Light mode" />
                </button>
                <button id="theme-dark" type="button">
                    <img src="/imgs/icons/ic_moon.png" alt="Dark mode" />
                </button>
            </div>
        </div>
    </header>
    <div class="layout">
        <aside class="sidebar">
            <nav>
                <a class="nav-link" href="/dashboard">Dashboard</a>
            </nav>
            <div class="sidebar-section" data-role-section="accountant">
                <p class="sidebar-title">ACCOUNTANT</p>
                <a class="nav-link" href="#" data-role-only="accountant">Calculator</a>
                <a class="nav-link active" href="/members" data-role-only="accountant">Members</a>
                <a class="nav-link" href="/fridays" data-role-only="accountant">Fridays</a>

            </div>
            <div class="sidebar-odds-toggle">
                <label class="sidebar-odds-toggle-label">Odds Format</label>
                <div class="odds-toggle">
                    <button type="button" id="global-odds-hk" class="odds-btn active"
                        onclick="setGlobalOddsType('hk')">HK</button>
                    <button type="button" id="global-odds-int" class="odds-btn"
                        onclick="setGlobalOddsType('int')">INT</button>
                </div>
            </div>
        </aside>
        <main class="main-content">
            <div class="members-container" data-role-only="accountant">
                <div class="page-header">
                    <div>
                        <h1>Members</h1>
                        <p class="members-count" id="members-count">0 members</p>
                    </div>
                    <button class="btn-primary" onclick="openCreateModal()">Add Member</button>
                </div>
                <div id="error-message" class="error-message" style="display: none;"></div>
                <div id="success-message" class="success-message" style="display: none;"></div>
                <table class="table members-table" id="members-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="members-tbody">
                        <tr>
                            <td colspan="3" class="empty-state">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="bet-master-content" data-role-only="bet" style="display: none;">
                <div class="empty-state" style="padding: 48px; text-align: center;">
                    <h2 style="font-size: 20px; font-weight: 400; margin-bottom: 8px; color: var(--text);">Bet Master
                        View</h2>
                    <p style="color: var(--text-muted);">Switch to Accountant role to manage members.</p>
                </div>
            </div>
        </main>
    </div>

    <div id="member-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Add Member</h2>
            </div>
            <form id="member-form" onsubmit="handleSubmit(event)">
                <div class="form-group">
                    <label for="member-name">Name *</label>
                    <input type="text" id="member-name" name="name" required maxlength="100" />
                </div>
                <div id="form-error" class="error-message" style="display: none;"></div>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const root = document.documentElement;
        const lightBtn = document.getElementById('theme-light');
        const darkBtn = document.getElementById('theme-dark');
        const roleAccountantBtn = document.getElementById('role-accountant');
        const roleBetBtn = document.getElementById('role-bet');
        const accountantSections = document.querySelectorAll('[data-role-section="accountant"], [data-role-only="accountant"]');

        const ROLE_COOKIE = 'lf_role';
        const THEME_COOKIE = 'lf_theme';

        function setCookie(name, value, days = 365) {
            const expires = new Date(Date.now() + days * 864e5).toUTCString();
            document.cookie = `${name}=${value}; expires=${expires}; path=/`;
        }

        function getCookie(name) {
            return document.cookie.split('; ').find(row => row.startsWith(`${name}=`))?.split('=')[1];
        }

        function setTheme(theme) {
            root.setAttribute('data-theme', theme);
            if (theme === 'light') {
                lightBtn.classList.add('active');
                darkBtn.classList.remove('active');
            } else {
                darkBtn.classList.add('active');
                lightBtn.classList.remove('active');
            }
            setCookie(THEME_COOKIE, theme);
        }

        function setRole(role) {
            const isAccountant = role === 'accountant';
            roleAccountantBtn.classList.toggle('active', isAccountant);
            roleBetBtn.classList.toggle('active', !isAccountant);
            accountantSections.forEach(section => {
                section.classList.toggle('hidden', !isAccountant);
            });

            // Toggle content visibility in main-content only
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                const accountantContent = mainContent.querySelectorAll('[data-role-only="accountant"]');
                const betContent = mainContent.querySelectorAll('[data-role-only="bet"]');

                accountantContent.forEach(el => {
                    el.style.display = isAccountant ? '' : 'none';
                });
                betContent.forEach(el => {
                    el.style.display = isAccountant ? 'none' : '';
                });
            }

            setCookie(ROLE_COOKIE, role);
        }

        lightBtn.addEventListener('click', () => setTheme('light'));
        darkBtn.addEventListener('click', () => setTheme('dark'));
        roleAccountantBtn.addEventListener('click', () => setRole('accountant'));
        roleBetBtn.addEventListener('click', () => setRole('bet'));

        const savedTheme = getCookie(THEME_COOKIE) || 'light';
        const savedRole = getCookie(ROLE_COOKIE) || 'accountant';
        setTheme(savedTheme);
        setRole(savedRole);

        let editingMemberId = null;

        async function loadMembers() {
            try {
                const response = await fetch('/api/members');
                if (!response.ok) throw new Error('Failed to load members');
                const members = await response.json();
                renderMembers(members);
            } catch (error) {
                showError('Failed to load members: ' + error.message);
                document.getElementById('members-tbody').innerHTML =
                    '<tr><td colspan="3" class="empty-state">Error loading members</td></tr>';
            }
        }

        function renderMembers(members) {
            const tbody = document.getElementById('members-tbody');
            const countEl = document.getElementById('members-count');

            // Update count
            const count = members.length;
            countEl.textContent = `${count} ${count === 1 ? 'member' : 'members'}`;

            if (members.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="empty-state">No members found</td></tr>';
                return;
            }
            tbody.innerHTML = members.map(member => `
                <tr>
                    <td>${member.id}</td>
                    <td>${escapeHtml(member.name)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-secondary" onclick="openEditModal(${member.id}, '${escapeHtml(member.name)}')">Edit</button>
                            <button class="btn-danger" onclick="deleteMember(${member.id})">Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function openCreateModal() {
            editingMemberId = null;
            document.getElementById('modal-title').textContent = 'Add Member';
            document.getElementById('member-form').reset();
            document.getElementById('form-error').style.display = 'none';
            document.getElementById('member-modal').classList.add('active');
        }

        function openEditModal(id, name) {
            editingMemberId = id;
            document.getElementById('modal-title').textContent = 'Edit Member';
            document.getElementById('member-name').value = name;
            document.getElementById('form-error').style.display = 'none';
            document.getElementById('member-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('member-modal').classList.remove('active');
            editingMemberId = null;
        }

        async function handleSubmit(event) {
            event.preventDefault();
            const name = document.getElementById('member-name').value.trim();
            const errorDiv = document.getElementById('form-error');

            if (!name) {
                errorDiv.textContent = 'Name is required';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const url = editingMemberId
                    ? `/api/members/${editingMemberId}`
                    : '/api/members';
                const method = editingMemberId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to save member');
                }

                closeModal();
                await loadMembers();
                hideError();
                showSuccess(`Member ${editingMemberId ? 'updated' : 'created'} successfully`);
            } catch (error) {
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
            }
        }

        async function deleteMember(id) {
            if (!confirm('Are you sure you want to delete this member?')) {
                return;
            }

            try {
                const response = await fetch(`/api/members/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete member');
                }

                await loadMembers();
                hideError();
                showSuccess('Member deleted successfully');
            } catch (error) {
                showError('Failed to delete member: ' + error.message);
            }
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            if (successDiv) {
                successDiv.textContent = message;
                successDiv.style.display = 'block';
                setTimeout(() => {
                    successDiv.style.display = 'none';
                }, 3000);
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('error-message').style.display = 'none';
        }

        loadMembers();
    </script>
</body>

</html>